apt_preferences
===============

[APT preferences](https://wiki.debian.org/AptPreferences) can be used to
influence package selection performed by APT during installation or upgrades.
You can for example tell APT that you prefer packages from certain repositories
or want to hold a package on a particular version no matter what (among other
things).

By default, if you don't specify version or provide custom pin configuration,
`apt_preferences` role will configure specified packages to be installed from
backports repository of a current OS release.

Role Variables
--------------

### Public variables

- `apt_preferences_list`: list of APT pins for all hosts in a cluster;

- `apt_preferences_group_list`: list of APT pins for hosts in a particular
  group;

- `apt_preferences_host_list`: list of APT pins for a particular host;

- `apt_preferences_dependent_list`: list of APT pins defined by another role
  using `apt_preferences` role as a dependency;

- `apt_preferences_priority_default`: default pin priority used if a custom one
  is not defined;

- `apt_preferences_priority_version`: default pin priority used if a pinned
  version is specified and no custom priority is set;

### Pin variables

Each pin should be defined as a hash in one of above `apt_preferences_*_list`
lists. All variables except `item.package` are optional, role will try to make
sensible choices if specific variables are not present.

- `item.package`: string of package names affected by this pin, each package
  separated by space. You can use `package-*` wildcard to specify multiple
  packages. First package name will be included in automatically generated
  filename of the pin preferences file.

- `item.backports`: list of OS releases which should be considered when
  `apt_preferences` role configures pin for a backported package. If current OS
  release is not on this list, pin won't be created, and existing pin will be
  removed. This should allow for easy transition to next OS release.

- `item.version`: specify a particular package version you want to pin, for
  exmple `5.10`. It will be configured with added `*` at the end to allow for
  upgrades. By default versioned pins are set with priority `1001`, which
  should ensure that selected pckage version is never upgraded, or it will be
  downgraded if required.

- `item.priority`: specify custom priority for a pin. By default pins are
  created with priority `500` to allow for easy installation of packages from
  backports, versioned pins are created with priority `1001`.

- `item.reason`: a short description explaining the reason for a pin. Might be
  used to point a system administrator to useful documentation explaining why
  a particular pin is defined.

- `item.filename`: name of the generated file with pin preferences, saved in
  ``/etc/apt/preferences.d/``. If undefined, `apt_preferences` role will
  automatically generate a filename.

- `item.suffix`: additional string added at the end of autogenerated filename,
  can be used to prevent filename collisions.

- `item.by_role`: name of a role which sets a particular pin. This name will be
  included in the autogenerated filename.

- `item.pin`: custom pin definition. If this variable is undefined,
  `apt_preferences` role will automatically configure selected packages with
  preference for a backported version.

- `item.raw`: instead of generating a pin automatically, use contents of this
  text block for pin configuration. Might be used to create several pins in
  one file.

- `item.delete`: if this variable is defined and `True`, preferences file for
  this pin will be deleted and new one will not be created.

Usage examples
--------------

This role can be used directly from a playbook, with pin configuration
specified direclty:

    ---
    - name: Install nginx from wheezy-backports on Wheezy
      hosts: all
      sudo: True
      roles:
         - role: ginas.apt_preferences
           tags: apt_preferences
           apt_preferences_list:
             - package: 'nginx nginx-*'
               backports: [ 'wheezy' ]
      tasks:
        - apt: name=nginx state=latest

More fine-grained configuration can be specified using inventory variables, for
example per group or per host:

    ---
    apt_preferences_group_list:
      - package: '*'
        suffix: '_testing'
        pin: 'release a=testing'
        priority: '900'
        reason: 'Prefer packages from testing'
    
      - package: '*'
        suffix: '_debian'
        pin: 'release o=Debian'
        priority: '-10'
        reason: 'Lower package preference from other releases'

You can also use `apt_preferences` as a dependency in another role:

    ---
    dependencies:
      - role: ginas.apt_preferences
        tags: apt_preferences
        apt_preferences_dependent_list:
          - package: 'mysql-server mysql-client mysql-common'
            version: '5.5'
            by_role: 'ginas.mysql'
            reason: 'Hold mysql on version 5.5*'

License
-------

GPLv3

Author Information
------------------

Maciej Delmanowski <drybjed@gmail.com>

This role is part of the [ginas](https://github.com/ginas/ginas/) project.

